#!/bin/bash

# Hide "last login" line when starting a new terminal session
touch $HOME/.hushlogin

# Install zsh
echo 'Install oh-my-zsh'
echo '-----------------'
rm -rf $HOME/.oh-my-zsh
curl -L https://raw.githubusercontent.com/robbyrussell/oh-my-zsh/master/tools/install.sh | sh

# Create dotfiles symlinks
source $HOME/.dotfiles/symlinks

# Configure git settings
git config --global core.excludesfile $HOME/.global-gitignore
git config --global push.autoSetupRemote true


# Activate z
cd ~/.dotfiles/shell
chmod +x z.sh

echo 'Install Bun'
curl -fsSL https://bun.sh/install | bash
export BUN_INSTALL="$HOME/.bun"
export PATH="$BUN_INSTALL/bin:$PATH"

echo 'Install Laravel Herd'
HERD_LATEST=$(curl -s https://api.github.com/repos/laravel/herd-community/releases/latest | grep -o '"tag_name": "[^"]*' | cut -d'"' -f4)
curl -L "https://github.com/laravel/herd-community/releases/download/${HERD_LATEST}/Herd.dmg" -o /tmp/Herd.dmg
hdiutil attach /tmp/Herd.dmg -quiet
cp -R /Volumes/Herd/Herd.app /Applications/
hdiutil detach /Volumes/Herd -quiet
rm /tmp/Herd.dmg

echo 'Install homebrew'
echo '----------------'
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> $HOME/.zprofile
eval "$(/opt/homebrew/bin/brew shellenv)"

echo 'Install Neovim and GitHub CLI'
echo '------------------------------'
brew install neovim gh



echo 'Install Kitty'
echo '--------------'
curl -L https://sw.kovidgoyal.net/kitty/installer.sh | sh /dev/stdin
# Create local bin directory and required icon directories
mkdir -p ~/.local/bin
mkdir -p ~/.local/share/icons/hicolor/256x256/apps
# Create Applications alias
ln -sf ~/.local/kitty.app/Contents/MacOS/kitty ~/.local/bin/
ln -sf ~/.local/kitty.app/Contents/MacOS/kitten ~/.local/bin/
cp ~/.local/kitty.app/Contents/Resources/kitty.icns ~/.local/share/icons/hicolor/256x256/apps/kitty.png
mkdir -p /Applications
ln -sf ~/.local/kitty.app /Applications/kitty.app

echo 'Install essential tools'
echo '----------------------'
# Create local bin directory for user binaries
mkdir -p ~/.local/bin

# Install global packages with bun (after bun is available)
export BUN_INSTALL="$HOME/.bun"
export PATH="$BUN_INSTALL/bin:$PATH"
echo 'Installing global packages with Bun...'
bun install -g httpie typescript @vue/cli vite prettier eslint nodemon serve concurrently rimraf aicommits

# Composer is included with Laravel Herd
echo 'Composer installation skipped (included with Laravel Herd)'
echo '--------------------------------------------------------'

echo 'Install Laravel tools with Herd composer'
echo '----------------------------------------'
~/.config/herd-lite/bin/composer global require "laravel/envoy"
~/.config/herd-lite/bin/composer global require spatie/phpunit-watcher


# Install zsh plugins manually
echo 'Install zsh plugins'
echo '------------------'
git clone https://github.com/zsh-users/zsh-autosuggestions ~/.oh-my-zsh/custom/plugins/zsh-autosuggestions
brew install zsh-autosuggestions zsh-syntax-highlighting

echo '++++++++++++++++++++++++++++++'
echo '++++++++++++++++++++++++++++++'
echo 'All done!'
echo 'Your system is now configured with:'
echo '- Laravel Herd (PHP development environment)'
echo '- Neovim (nvim) text editor'
echo '- Kitty terminal emulator'
echo '- Bun JavaScript runtime and package manager'
echo ''
echo 'Next steps:'
echo '1. Install fonts for terminal theme: ~/.dotfiles/misc'
echo '2. Configure Laravel Herd by opening the application'
echo '3. Set macOS defaults: ~/.dotfiles/macos/set-defaults.sh'
echo '4. Create custom aliases: ~/.dotfiles-custom/shell/.aliases'
echo '5. Restart your terminal or run: source ~/.zshrc'

echo '++++++++++++++++++++++++++++++'
echo 'Additional Notes:'

echo '1. Neovim config is located at ~/.config/nvim/init.lua'
echo '2. Kitty config is located at ~/.config/kitty/kitty.conf'
echo '3. Laravel Herd replaces Valet and includes PHP/MySQL'

echo '++++++++++++++++++++++++++++++'
echo '++++++++++++++++++++++++++++++'
